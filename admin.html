<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Tajawal', 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.5rem 0;
    }
    .logo {
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
    }
    .logo span { color: #25D366; }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      padding: 1.8rem;
      overflow: hidden;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .card-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: #2c3e50;
    }
    .stats {
      display: flex;
      gap: 1rem;
      font-size: 0.95rem;
    }
    .stat { padding: 6px 12px; border-radius: 8px; background: #f1f3f5; }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th {
      background: #f8f9fa;
      padding: 14px 12px;
      text-align: right;
      font-weight: 600;
      color: #2c3e50;
      border-bottom: 2px solid #e9ecef;
    }
    td {
      padding: 14px 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    tr:hover { background: #f9fafb; }
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .status-confirmed { background: #d4edda; color: #155724; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    .status-dropdown {
      width: 120px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ced4da;
      font-family: inherit;
      font-size: 0.9rem;
      background: white;
      cursor: pointer;
    }
    .phone-link {
      color: #3498db;
      text-decoration: none;
    }
    .phone-link:hover { text-decoration: underline; }
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6c757d;
    }
    .empty-state p { margin-top: 0.5rem; }
    @media (max-width: 768px) {
      .card { padding: 1.2rem; }
      th, td { padding: 10px 8px; }
      .card-header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… <span>Ù…Ø·Ø¹Ù…Ùƒ</span></div>
    </header>

    <main>
      <div class="card">
        <div class="card-header">
          <h1 class="card-title">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h1>
          <div class="stats">
            <div class="stat">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-count">â€”</span></div>
            <div class="stat">Ù…Ø¤ÙƒØ¯Ø©: <span id="confirmed-count">â€”</span></div>
          </div>
        </div>

        <div class="table-container">
          <table id="bookings-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø¹Ø±Ù</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="bookings-list">
              <tr><td colspan="7" class="empty-state">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ğŸ”¥ Firebase Config (Ù†ÙØ³ Ø§Ù„ÙƒØªÙ„Ø© Ø§Ù„Ù…ÙØ³ØªØ®Ø¯Ù…Ø© ÙÙŠ index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyAnH3AczYq13NMVA18BhucGzeffEuC5QIM",
      authDomain: "table-booking-5d9d4.firebaseapp.com",
      databaseURL: "https://table-booking-5d9d4-default-rtdb.firebaseio.com",
      projectId: "table-booking-5d9d4",
      storageBucket: "table-booking-5d9d4.firebasestorage.app",
      messagingSenderId: "1097720872360",
      appId: "1:1097720872360:web:b8d94656b7440b4353719d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
    function formatTimestamp(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString('ar-SA', { day: '2-digit', month: 'short' }) + 
             'ØŒ ' + d.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Firebase
    function updateStatus(bookingId, newStatus) {
      db.ref(`bookings/${bookingId}/status`).set(newStatus)
        .catch(err => {
          console.error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©:", err);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.");
        });
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
    function renderBookings(bookings) {
      const tbody = document.getElementById('bookings-list');
      const totalCount = document.getElementById('total-count');
      const confirmedCount = document.getElementById('confirmed-count');

      totalCount.textContent = bookings.length;
      confirmedCount.textContent = bookings.filter(b => b.status === 'confirmed').length;

      if (bookings.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty-state">
          <div>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯</div>
          <p>Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø­Ø¬Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</p>
        </td></tr>`;
        return;
      }

      tbody.innerHTML = bookings.map(b => {
        const statusClass = {
          'confirmed': 'confirmed',
          'cancelled': 'cancelled',
          'pending': 'pending'
        }[b.status || 'pending'];

        const statusText = {
          'confirmed': 'âœ… Ù…Ø¤ÙƒÙ‘Ø¯',
          'cancelled': 'âŒ Ù…Ù„ØºÙ‰',
          'pending': 'â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø±'
        }[b.status || 'pending'];

        return `
          <tr>
            <td><code>${b.id?.substring(0,6) || 'â€”'}</code></td>
            <td>${b.name || 'â€”'}</td>
            <td dir="ltr">
              <a href="https://wa.me/${b.phone}" target="_blank" class="phone-link">+${b.phone}</a>
            </td>
            <td>${b.dateDisplay || b.date || 'â€”'}</td>
            <td>${b.time || 'â€”'}</td>
            <td>
              <span class="status-badge status-${statusClass}">${statusText}</span>
            </td>
            <td>
              <select class="status-dropdown" data-id="${b.id}" ${!b.id ? 'disabled' : ''}>
                <option value="pending" ${b.status === 'pending' ? 'selected' : ''}>â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø±</option>
                <option value="confirmed" ${b.status === 'confirmed' ? 'selected' : ''}>âœ… Ù…Ø¤ÙƒÙ‘Ø¯</option>
                <option value="cancelled" ${b.status === 'cancelled' ? 'selected' : ''}>âŒ Ù…Ù„ØºÙ‰</option>
              </select>
            </td>
          </tr>`;
      }).join('');

      // Ø±Ø¨Ø· Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
      document.querySelectorAll('.status-dropdown').forEach(select => {
        select.addEventListener('change', function() {
          const id = this.getAttribute('data-id');
          const newStatus = this.value;
          updateStatus(id, newStatus);
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø¯Ø¬ ÙÙˆØ±Ù‹Ø§ (UX Ø£ÙØ¶Ù„)
          const row = this.closest('tr');
          const badge = row.querySelector('.status-badge');
          const newText = {
            'confirmed': 'âœ… Ù…Ø¤ÙƒÙ‘Ø¯',
            'cancelled': 'âŒ Ù…Ù„ØºÙ‰',
            'pending': 'â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø±'
          }[newStatus];
          const newClass = {
            'confirmed': 'status-confirmed',
            'cancelled': 'status-cancelled',
            'pending': 'status-pending'
          }[newStatus];
          badge.className = 'status-badge ' + newClass;
          badge.textContent = newText;
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
          renderStats();
        });
      });
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„)
    function renderStats() {
      db.ref('bookings').once('value').then(snapshot => {
        const bookings = [];
        snapshot.forEach(child => bookings.push(child.val()));
        const total = bookings.length;
        const confirmed = bookings.filter(b => b.status === 'confirmed').length;
        document.getElementById('total-count').textContent = total;
        document.getElementById('confirmed-count').textContent = confirmed;
      });
    }

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
    db.ref('bookings')
      .orderByChild('timestamp')
      .on('value', (snapshot) => {
        const bookings = [];
        snapshot.forEach(child => {
          const b = child.val();
          // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
          if (!b.status) b.status = 'pending';
          bookings.push(b);
        });
        // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
        bookings.reverse();
        renderBookings(bookings);
      }, (error) => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        document.getElementById('bookings-list').innerHTML = 
          `<tr><td colspan="7" class="empty-state">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.</td></tr>`;
      });
  </script>
</body>
</html>
